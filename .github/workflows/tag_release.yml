---
name: Tag Release

"on":
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  tag_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch tags
        run: git fetch --tags --force

      - name: Check pyproject.toml change
        id: pyproject_change
        run: |
          if git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" | grep -q '^pyproject\.toml$'; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Read current version
        id: current_version
        if: steps.pyproject_change.outputs.changed == 'true'
        run: |
          version=$(python - <<'PY'
          import pathlib
          import tomllib

          data = tomllib.loads(pathlib.Path("pyproject.toml").read_text())
          print(data["project"]["version"])
          PY
          )
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Read previous version
        id: previous_version
        if: steps.pyproject_change.outputs.changed == 'true'
        run: |
          if git show "${{ github.event.before }}:pyproject.toml" > /tmp/pyproject.toml 2>/dev/null; then
            previous=$(python - <<'PY'
            import pathlib
            import tomllib

            data = tomllib.loads(pathlib.Path("/tmp/pyproject.toml").read_text())
            print(data["project"]["version"])
            PY
            )
            echo "version=$previous" >> "$GITHUB_OUTPUT"
          else
            echo "version=" >> "$GITHUB_OUTPUT"
          fi

      - name: Compare versions
        id: version_compare
        if: steps.pyproject_change.outputs.changed == 'true'
        run: |
          if [ -z "${{ steps.previous_version.outputs.version }}" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "${{ steps.current_version.outputs.version }}" = "${{ steps.previous_version.outputs.version }}" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Tag release
        if: steps.version_compare.outputs.changed == 'true'
        run: |
          version="${{ steps.current_version.outputs.version }}"
          IFS='.' read -r major minor patch <<< "$version"

          git tag -f "v${major}" "${{ github.sha }}"
          git tag -f "v${major}.${minor}" "${{ github.sha }}"
          git tag -f "v${major}.${minor}.${patch}" "${{ github.sha }}"

          git push origin -f "v${major}" "v${major}.${minor}" "v${major}.${minor}.${patch}"
