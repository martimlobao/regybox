---
name: Tag Release

on: # yamllint disable-line rule:truthy
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  tag_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Fetch tags
        run: git fetch --tags --force

      - name: Check pyproject.toml change
        id: pyproject_change
        run: |
          base="${{ github.event.before }}"
          if [ "$base" = "0000000000000000000000000000000000000000" ] \
            || ! git cat-file -e "$base^{commit}" 2>/dev/null; then
            base=""
          fi

          if [ -z "$base" ]; then
            if [ -f pyproject.toml ]; then
              echo "changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "changed=false" >> "$GITHUB_OUTPUT"
            fi
            exit 0
          fi

          if git diff --name-only "$base" "${{ github.sha }}" | grep -q '^pyproject\.toml$'; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Read current version
        id: current_version
        if: steps.pyproject_change.outputs.changed == 'true'
        run: |
          version=$(uv run python -c \
            'import pathlib, tomllib; ' \
            'data = tomllib.loads(pathlib.Path("pyproject.toml").read_text()); ' \
            'print(data["project"]["version"])')
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Read previous version
        id: previous_version
        if: steps.pyproject_change.outputs.changed == 'true'
        run: |
          if git show "${{ github.event.before }}:pyproject.toml" > /tmp/pyproject.toml 2>/dev/null; then
            previous=$(uv run python -c \
              'import pathlib, tomllib; ' \
              'data = tomllib.loads(pathlib.Path("/tmp/pyproject.toml").read_text()); ' \
              'print(data["project"]["version"])')
            echo "version=$previous" >> "$GITHUB_OUTPUT"
          else
            echo "version=" >> "$GITHUB_OUTPUT"
          fi

      - name: Compare versions
        id: version_compare
        if: steps.pyproject_change.outputs.changed == 'true'
        run: |
          if [ -z "${{ steps.previous_version.outputs.version }}" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "${{ steps.current_version.outputs.version }}" = "${{ steps.previous_version.outputs.version }}" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Tag release
        if: steps.version_compare.outputs.changed == 'true'
        run: |
          version="${{ steps.current_version.outputs.version }}"
          if ! [[ "$version" =~ ^[0-9]+(\.[0-9]+){0,2}$ ]]; then
            echo "Unsupported version format: $version"
            exit 0
          fi

          IFS='.' read -r major minor patch <<< "$version"
          major_tag="v${major}"
          minor_tag=""
          patch_tag=""

          if [ -n "$minor" ]; then
            minor_tag="v${major}.${minor}"
          fi

          if [ -n "$patch" ]; then
            patch_tag="v${major}.${minor}.${patch}"
          fi

          git tag -f "$major_tag" "${{ github.sha }}"
          if [ -n "$minor_tag" ]; then
            git tag -f "$minor_tag" "${{ github.sha }}"
          fi
          if [ -n "$patch_tag" ]; then
            git tag -f "$patch_tag" "${{ github.sha }}"
          fi

          if [ -n "$minor_tag" ]; then
            git push origin -f "$major_tag" "$minor_tag"
          else
            git push origin -f "$major_tag"
          fi

          if [ -n "$patch_tag" ]; then
            git push origin "$patch_tag"
          fi
