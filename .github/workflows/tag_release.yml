---
name: Tag Release

on: # yamllint disable-line rule:truthy
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  tag_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fetch tags
        run: git fetch --tags --force

      - name: Read current version
        id: current_version
        run: |
          set -euo pipefail
          if [ ! -f pyproject.toml ]; then
            echo "pyproject.toml not found." >&2
            exit 1
          fi

          version=$(python - <<'PY'
          import pathlib
          import tomllib

          data = tomllib.loads(pathlib.Path("pyproject.toml").read_text())
          version = data.get("project", {}).get("version")
          if not version:
              raise SystemExit("pyproject.toml is missing project.version")
          print(version)
          PY
          )
          printf 'version=%s\n' "$version" >> "$GITHUB_OUTPUT"

      - name: Read latest tag
        id: latest_tag
        run: |
          set -euo pipefail
          latest_tag=$(git tag --list 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -n1)
          printf 'tag=%s\n' "$latest_tag" >> "$GITHUB_OUTPUT"

      - name: Compare versions
        id: version_compare
        run: |
          set -euo pipefail
          if [ -z "${{ steps.current_version.outputs.version }}" ]; then
            echo "Current version could not be read from pyproject.toml." >&2
            exit 1
          fi

          current_tag="v${{ steps.current_version.outputs.version }}"
          if git show-ref --tags --verify --quiet "refs/tags/${current_tag}"; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Tag release
        if: steps.version_compare.outputs.changed == 'true'
        run: |
          set -euo pipefail
          version="${{ steps.current_version.outputs.version }}"
          if ! [[ "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Unsupported version format: $version" >&2
            exit 1
          fi

          IFS='.' read -r major minor patch <<< "$version"
          major_tag="v${major}"
          minor_tag=""
          patch_tag=""

          minor_tag="v${major}.${minor}"
          patch_tag="v${major}.${minor}.${patch}"

          git tag -f "$major_tag" "${{ github.sha }}"
          git tag -f "$minor_tag" "${{ github.sha }}"
          git tag -f "$patch_tag" "${{ github.sha }}"

          git push origin "$patch_tag"
          git push origin -f "$major_tag" "$minor_tag"
